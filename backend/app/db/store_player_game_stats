from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, delete
from app.models.player import Player
from app.models.player_game_stat import PlayerGameStat
from datetime import datetime


async def save_last_5_games(
    player_id: int,
    player_name: str,
    team_abbr: str,
    df,
    db: AsyncSession,
):
    # --- Player ---
    player = await db.get(Player, player_id)
    if not player:
        player = Player(
            id=player_id,
            full_name=player_name,
            team_abbreviation=team_abbr,
        )
        db.add(player)
        await db.flush()

    # Keep only last 5 games
    df = df.sort_values("GAME_DATE", ascending=False).head(5)

    # delete rows older than 5
    stmt = select(PlayerGameStat).where(PlayerGameStat.player_id == player_id)
    res = await db.execute(stmt)
    existing = res.scalars().all()

    if len(existing) >= 5:
        delete_stmt = delete(PlayerGameStat).where(
            PlayerGameStat.player_id == player_id
        )
        await db.execute(delete_stmt)

    # Insert games
    for _, row in df.iterrows():
        game = PlayerGameStat(
            player_id=player_id,
            game_id=row["Game_ID"],
            game_date=datetime.strptime(row["GAME_DATE"], "%Y-%m-%d").date(),
            matchup=row["MATCHUP"],
            minutes=row["MIN"],
            points=row["PTS"],
            assists=row["AST"],
            rebounds=row["REB"],
            steals=row["STL"],
            blocks=row["BLK"],
            turnovers=row["TOV"],
        )
        db.add(game)

    await db.commit()
